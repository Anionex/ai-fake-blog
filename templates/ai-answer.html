<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI回答 - 我的博客</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .ai-answer {
            background: #fff;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .ai-answer h1 {
            color: #0366d6;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ""; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }
        
        .error-message {
            color: #dc3545;
            padding: 1rem;
            border: 1px solid #dc3545;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .api-key-form {
            margin: 2rem 0;
        }
        
        .api-key-form input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .api-key-form button {
            background: #0366d6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .api-key-form button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <header>
        <h1>我的博客</h1>
        <nav>
            <div class="nav-links">
                <a href="/">首页</a>
                <a href="/about.html">关于</a>
            </div>
            <div class="search-container">
                <form id="searchForm" onsubmit="handleSearch(event)">
                    <input type="search" id="searchInput" placeholder="搜索文章...">
                </form>
            </div>
        </nav>
    </header>

    <main>
        <a href="/" class="back-link">← 返回首页</a>
        <div id="content" class="ai-answer">
            <!-- AI回答将被动态插入 -->
        </div>
    </main>

    <footer>
        <p>&copy; 2024 我的博客</p>
    </footer>

    <script>
        let apiKey = localStorage.getItem('openai_api_key');
        
        async function getAIAnswer(question) {
            if (!apiKey) {
                showApiKeyForm();
                return;
            }
            
            document.getElementById('content').innerHTML = '<div class="loading">正在生成回答</div>';
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: '你是一个专业、友好的助手。请用中文回答问题，回答要详细且有见地。'
                            },
                            {
                                role: 'user',
                                content: question
                            }
                        ],
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API请求失败');
                }
                
                const data = await response.json();
                const answer = data.choices[0].message.content;
                
                document.getElementById('content').innerHTML = `
                    <h1>${question}</h1>
                    <div class="answer-content">${formatAnswer(answer)}</div>
                `;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error-message">
                        <p>获取AI回答时出错。可能的原因：</p>
                        <ul>
                            <li>API密钥无效或已过期</li>
                            <li>网络连接问题</li>
                            <li>OpenAI服务暂时不可用</li>
                        </ul>
                        <button onclick="resetApiKey()">重置API密钥</button>
                    </div>
                `;
            }
        }
        
        function formatAnswer(text) {
            return text.replace(/\n/g, '<br>');
        }
        
        function showApiKeyForm() {
            document.getElementById('content').innerHTML = `
                <h1>需要OpenAI API密钥</h1>
                <div class="api-key-form">
                    <p>请输入您的OpenAI API密钥以继续：</p>
                    <input type="password" id="apiKeyInput" placeholder="sk-...">
                    <button onclick="saveApiKey()">保存并继续</button>
                    <p><small>注：API密钥将安全地存储在您的浏览器中。</small></p>
                </div>
            `;
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                loadContent();
            }
        }
        
        function resetApiKey() {
            localStorage.removeItem('openai_api_key');
            apiKey = null;
            showApiKeyForm();
        }
        
        function handleSearch(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value;
            window.location.href = `../search.html?q=${encodeURIComponent(searchTerm)}`;
        }
        
        function loadContent() {
            const params = new URLSearchParams(window.location.search);
            const question = params.get('q');
            
            if (!question) {
                document.getElementById('content').innerHTML = '<p>未找到问题</p>';
                return;
            }
            
            document.title = `${question} - AI回答`;
            getAIAnswer(question);
        }
        
        loadContent();
    </script>
</body>
</html> 